<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Virtual Try-On (Webcam + Photo)</title>
  <style>
    :root { 
      --bg:#f9fafb;
      --fg:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
      --accent:#2563eb;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
      background:var(--bg);
      color:var(--fg);
    }

    header{
      padding:18px 20px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      background:#ffffff;
    }
    h1{font-size:18px;margin:0;letter-spacing:.2px;color:#111827}

    main{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px}
    @media (max-width:1000px){main{grid-template-columns:1fr}}

    .panel{
      background:var(--card);
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:14px;
      box-shadow:0 1px 3px rgba(0,0,0,0.06);
    }
    .panel h2{margin:0 0 10px 0;font-size:14px;color:#374151}

    .controls{display:grid;gap:10px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .btn{
      background:#f3f4f6;
      border:1px solid #d1d5db;
      color:#1f2937;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:background .2s;
    }
    .btn:hover:not([disabled]){background:#e5e7eb}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn.primary:hover:not([disabled]){background:#1d4ed8}

    label{font-size:12px;color:#374151}
    input[type="file"]{font-size:12px}
    .slider{width:100%}

    .canvasWrap{
      position:relative;
      background:#f3f4f6;
      border-radius:16px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      min-height:360px
    }
    #output{display:block;width:100%;height:auto}

    footer{
      padding:10px 16px;
      color:#6b7280;
      font-size:12px;
      border-top:1px solid #e5e7eb;
      background:#ffffff;
    }

    .toggle{display:inline-flex;gap:8px;align-items:center}

    select, input[type="range"], input[type="checkbox"]{
      accent-color:var(--accent);
    }
  </style>
</head>
<body>
  <header>
    <h1>üëó Virtual Try-On</h1>
  </header>

  <main>
    <section class="panel">
      <h2>1) Source</h2>
      <div class="controls">
        <div class="row">
          <button id="startCam" class="btn primary">Enable Webcam</button>
          <button id="stopCam" class="btn" disabled>Stop Webcam</button>
        </div>
        <div class="row">
          <label>Or upload a photo:
            <input type="file" id="photoInput" accept="image/*" />
          </label>
        </div>
      </div>

      <h2 style="margin-top:16px">2) Outfit</h2>
      <div class="controls">
        <div class="row">
          <label>Choose outfit image:
            <input type="file" id="outfitInput" accept="image/png,image/jpeg" />
          </label>
        </div>
        <div class="row">
          <button class="btn" id="sampleTop">Load Sample Top</button>
          <button class="btn" id="sampleLehenga">Load Sample Lehenga</button>
          <button class="btn" id="clearOutfit">Clear Outfit</button>
        </div>
      </div>

      <h2 style="margin-top:16px">3) Alignment</h2>
      <div class="controls">
        <label>Scale
          <input id="scale" class="slider" type="range" min="0.5" max="2.0" step="0.01" value="1.0" />
        </label>
        <label>Rotation (¬∞)
          <input id="rotation" class="slider" type="range" min="-45" max="45" step="0.5" value="0" />
        </label>
        <label>Offset X
          <input id="offsetX" class="slider" type="range" min="-300" max="300" step="1" value="0" />
        </label>
        <label>Offset Y
          <input id="offsetY" class="slider" type="range" min="-300" max="300" step="1" value="0" />
        </label>
        <label class="toggle">
          <input type="checkbox" id="segMaskToggle" checked /> Use person segmentation
        </label>
        <label class="toggle">
          <input type="checkbox" id="lockTorso" checked /> Auto-lock to torso
        </label>
      </div>

      <h2 style="margin-top:16px">4) Export</h2>
      <div class="controls">
        <button class="btn" id="snap">Save Snapshot (PNG)</button>
        <a id="downloadLink" class="btn" download="tryon.png" style="display:none">Download</a>
      </div>
    </section>

    <section class="panel">
      <h2>Preview</h2>
      <div class="canvasWrap">
        <video id="video" playsinline style="display:none"></video>
        <canvas id="output"></canvas>
      </div>
    </section>
  </main>

  <footer>
    ‚ù§ Built for demo ‚Ä¢ Works best in Chrome/Edge/Android.
  </footer>

  <!-- MediaPipe libs -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1/selfie_segmentation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');

    const startBtn = document.getElementById('startCam');
    const stopBtn = document.getElementById('stopCam');
    const photoInput = document.getElementById('photoInput');

    const outfitInput = document.getElementById('outfitInput');
    const sampleTopBtn = document.getElementById('sampleTop');
    const sampleLehengaBtn = document.getElementById('sampleLehenga');
    const clearOutfitBtn = document.getElementById('clearOutfit');

    const scaleEl = document.getElementById('scale');
    const rotEl = document.getElementById('rotation');
    const offXEl = document.getElementById('offsetX');
    const offYEl = document.getElementById('offsetY');
    const segMaskToggle = document.getElementById('segMaskToggle');
    const lockTorsoEl = document.getElementById('lockTorso');

    const snapBtn = document.getElementById('snap');
    const dl = document.getElementById('downloadLink');

    let camera = null, stream = null;
    let lastVideoW = 0, lastVideoH = 0;
    let currentImage = null;

    let outfitImg = new Image();
    let outfitReady = false;

    function loadOutfitFromURL(url){
      outfitImg = new Image();
      outfitImg.crossOrigin = 'anonymous';
      outfitImg.onload = ()=>{ outfitReady = true; };
      outfitImg.onerror = ()=>{ outfitReady = false; alert('Failed to load outfit image'); };
      outfitImg.src = url;
    }

    sampleTopBtn.onclick = ()=> loadOutfitFromURL('https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=600&auto=format');
    sampleLehengaBtn.onclick = ()=> loadOutfitFromURL('https://images.unsplash.com/photo-1605497788044-5a32c7078486?q=80&w=600&auto=format');
    clearOutfitBtn.onclick = ()=>{ outfitReady = false; };

    outfitInput.onchange = (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      loadOutfitFromURL(url);
    };

    const pose = new Pose({locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, enableSegmentation: false, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

    let lastPose = null;
    pose.onResults((res)=>{ lastPose = res; });

    const selfieSeg = new SelfieSegmentation({locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1/${f}`});
    selfieSeg.setOptions({ modelSelection: 1 });
    let lastSegMask = null;
    selfieSeg.onResults((res)=>{ lastSegMask = res.segmentationMask; });

    async function startWebcam(){
      if (stream) return;
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user', width:{ideal:1280}, height:{ideal:720}}, audio:false});
        video.srcObject = stream;
        await video.play();
        startBtn.disabled = true; stopBtn.disabled = false; photoInput.value = '';
        currentImage = null;
        fitCanvasTo(video.videoWidth, video.videoHeight);
        camera = new Camera(video, {
          onFrame: async () => {
            await pose.send({image: video});
            if (segMaskToggle.checked) await selfieSeg.send({image: video});
            drawFrame(video);
          },
          width: video.videoWidth || 1280,
          height: video.videoHeight || 720
        });
        camera.start();
      }catch(err){
        alert('Camera error: '+ err.message);
      }
    }

    function stopWebcam(){
      if (camera) { camera.stop(); camera = null; }
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      startBtn.disabled = false; stopBtn.disabled = true;
    }

    startBtn.onclick = startWebcam;
    stopBtn.onclick = stopWebcam;

    photoInput.onchange = (e)=>{
      stopWebcam();
      const file = e.target.files[0];
      if(!file) return;
      const img = new Image();
      img.onload = async ()=>{
        currentImage = img;
        fitCanvasTo(img.width, img.height);
        await pose.send({image: img});
        if (segMaskToggle.checked) await selfieSeg.send({image: img});
        drawFrame(img);
      };
      img.src = URL.createObjectURL(file);
    };

    function fitCanvasTo(w, h){
      if (w && h && (w !== lastVideoW || h !== lastVideoH)){
        lastVideoW = w; lastVideoH = h;
        const wrap = canvas.parentElement;
        const wrapW = wrap.clientWidth;
        const ratio = w/h;
        canvas.width = w; canvas.height = h;
        canvas.style.width = '100%';
        canvas.style.height = `${Math.round(wrapW/ratio)}px`;
      }
    }

    function torsoBoxFromLandmarks(landmarks){
      const L = landmarks[11], R = landmarks[12], LH = landmarks[23], RH = landmarks[24];
      if (!L || !R || !LH || !RH) return null;
      const x1 = Math.min(L.x, R.x, LH.x, RH.x);
      const x2 = Math.max(L.x, R.x, LH.x, RH.x);
      const y1 = Math.min(L.y, R.y);
      const y2 = Math.max(LH.y, RH.y);
      return {x1, y1, x2, y2, L, R};
    }

    function drawOutfit(){
      if (!outfitReady) return;
      const res = lastPose;
      const lockTorso = lockTorsoEl.checked;

      const s = parseFloat(scaleEl.value);
      const rot = parseFloat(rotEl.value) * Math.PI / 180;
      const offX = parseFloat(offXEl.value);
      const offY = parseFloat(offYEl.value);

      let cx = canvas.width/2, cy = canvas.height/2, w = canvas.width * 0.5, h = canvas.height * 0.6, angle = 0;

      if (lockTorso && res && res.poseLandmarks?.length){
        const box = torsoBoxFromLandmarks(res.poseLandmarks);
        if (box){
          const px = (box.x1 + box.x2)/2 * canvas.width;
          const py = (box.y1 + box.y2)/2 * canvas.height;
          const torsoW = (box.x2 - box.x1) * canvas.width * 1.2;
          const torsoH = (box.y2 - box.y1) * canvas.height * 1.3;
          cx = px; cy = py; w = torsoW; h = torsoH;
          const dx = (box.R.x - box.L.x) * canvas.width;
          const dy = (box.R.y - box.L.y) * canvas.height;
          angle = Math.atan2(dy, dx);
        }
      }

      ctx.save();
      ctx.translate(cx + offX, cy + offY);
      ctx.rotate(angle + rot);
      ctx.scale(s, s);
      ctx.drawImage(outfitImg, -w/2, -h/2, w, h);
      ctx.restore();
    }

    function drawFrame(base){
      if (!base) return;
      fitCanvasTo(base.videoWidth || base.width, base.videoHeight || base.height);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (segMaskToggle.checked && lastSegMask){
        ctx.drawImage(base, 0, 0, canvas.width, canvas.height);
        drawOutfit();
      } else {
        ctx.drawImage(base, 0, 0, canvas.width, canvas.height);
        drawOutfit();
      }
    }

    snapBtn.onclick = ()=>{
      const url = canvas.toDataURL('image/png');
      dl.href = url; dl.style.display = 'inline-block';
    };

    fitCanvasTo(1280, 720);
  </script>
</body>
</html>
